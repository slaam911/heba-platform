{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}إنشاء حساب جديد - منصة هبة{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white text-center py-4">
                    <h4 class="mb-0 fw-bold text-danger">إنشاء حساب جديد</h4>
                    <p class="text-muted mb-0">انضم إلى مجتمع المتبرعين بالدم</p>
                </div>
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger text-center mb-4">
                            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <h5 class="mb-3 fw-bold text-danger">معلومات العضوية</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ form.username.label_tag }}{{ form.username|add_class:'form-control' }}{% if form.username.errors %}<div class="invalid-feedback d-block">{% for error in form.username.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.email.label_tag }}{{ form.email|add_class:'form-control' }}{% if form.email.errors %}<div class="invalid-feedback d-block">{% for error in form.email.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.password1.label_tag }}{{ form.password1|add_class:'form-control' }}<small class="form-text text-muted">يجب أن تحتوي على أحرف كبيرة وصغيرة ورقم ورمز واحد على الأقل</small>{% if form.password1.errors %}<div class="invalid-feedback d-block">{% for error in form.password1.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.password2.label_tag }}{{ form.password2|add_class:'form-control' }}{% if form.password2.errors %}<div class="invalid-feedback d-block">{% for error in form.password2.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.phone_number.label_tag }}{{ form.phone_number|add_class:'form-control' }}{% if form.phone_number.errors %}<div class="invalid-feedback d-block">{% for error in form.phone_number.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                        </div>
                        <h5 class="mb-3 mt-4 fw-bold text-danger">المعلومات الشخصية</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">{{ form.first_name.label_tag }}{{ form.first_name|add_class:'form-control' }}{% if form.first_name.errors %}<div class="invalid-feedback d-block">{% for error in form.first_name.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-4 mb-3">{{ form.middle_name.label_tag }}{{ form.middle_name|add_class:'form-control' }}{% if form.middle_name.errors %}<div class="invalid-feedback d-block">{% for error in form.middle_name.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-4 mb-3">{{ form.last_name.label_tag }}{{ form.last_name|add_class:'form-control' }}{% if form.last_name.errors %}<div class="invalid-feedback d-block">{% for error in form.last_name.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.gender.label_tag }}{{ form.gender|add_class:'form-select' }}{% if form.gender.errors %}<div class="invalid-feedback d-block">{% for error in form.gender.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.nationality.label_tag }}{{ form.nationality|add_class:'form-select' }}{% if form.nationality.errors %}<div class="invalid-feedback d-block">{% for error in form.nationality.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.region.label_tag }}{{ form.region|add_class:'form-select' }}{% if form.region.errors %}<div class="invalid-feedback d-block">{% for error in form.region.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.city.label_tag }}{{ form.city|add_class:'form-select' }}{% if form.city.errors %}<div class="invalid-feedback d-block">{% for error in form.city.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.district.label_tag }}{{ form.district|add_class:'form-control' }}{% if form.district.errors %}<div class="invalid-feedback d-block">{% for error in form.district.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                        </div>
                        <h5 class="mb-3 mt-4 fw-bold text-danger">المعلومات الصحية</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">{{ form.age.label_tag }}{{ form.age|add_class:'form-control' }}{% if form.age.errors %}<div class="invalid-feedback d-block">{% for error in form.age.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-4 mb-3">{{ form.blood_type.label_tag }}{{ form.blood_type|add_class:'form-select' }}{% if form.blood_type.errors %}<div class="invalid-feedback d-block">{% for error in form.blood_type.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-4 mb-3">{{ form.has_donated.label_tag }}{{ form.has_donated|add_class:'form-select' }}{% if form.has_donated.errors %}<div class="invalid-feedback d-block">{% for error in form.has_donated.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.previous_blood_bank.label_tag }}{{ form.previous_blood_bank|add_class:'form-control' }}{% if form.previous_blood_bank.errors %}<div class="invalid-feedback d-block">{% for error in form.previous_blood_bank.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-6 mb-3">{{ form.has_chronic_disease.label_tag }}{{ form.has_chronic_disease|add_class:'form-select' }}{% if form.has_chronic_disease.errors %}<div class="invalid-feedback d-block">{% for error in form.has_chronic_disease.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                            <div class="col-md-12 mb-3">{{ form.chronic_disease_type.label_tag }}{{ form.chronic_disease_type|add_class:'form-control' }}{% if form.chronic_disease_type.errors %}<div class="invalid-feedback d-block">{% for error in form.chronic_disease_type.errors %}{{ error }}{% endfor %}</div>{% endif %}</div>
                        </div>
                        <div class="mb-4">
                            <div class="form-check">
                                {{ form.terms }}
                                <label class="form-check-label" for="terms">
                                    أوافق على <a href="#" class="text-primary">الشروط والأحكام</a> و <a href="#" class="text-primary">سياسة الخصوصية</a>
                                </label>
                                {% if form.terms.errors %}<div class="invalid-feedback d-block">{% for error in form.terms.errors %}{{ error }}{% endfor %}</div>{% endif %}
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-danger btn-lg">إنشاء الحساب</button>
                            <p class="text-center text-muted mt-3">
                                لديك حساب بالفعل؟ <a href="{% url 'users:login' %}" class="text-primary">تسجيل الدخول</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تفعيل التحقق من صحة النموذج
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // تحديث قائمة المدن عند تغيير المنطقة
    const regionSelect = document.getElementById('region');
    const citySelect = document.getElementById('city');

    regionSelect.addEventListener('change', function() {
        const region = this.value;
        citySelect.innerHTML = '<option value="">غير محدد</option>';
        
        if (region) {
            fetch(`/users/api/cities/?region=${region}`)
                .then(response => response.json())
                .then(cities => {
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        citySelect.appendChild(option);
                    });
                });
        }
    });

    // إظهار/إخفاء حقول إضافية
    const hasDonatedSelect = document.getElementById('has_donated');
    const bloodBankDetails = document.getElementById('blood_bank_details');
    const hasChronicDiseaseSelect = document.getElementById('has_chronic_disease');
    const chronicDiseaseDetails = document.getElementById('chronic_disease_details');

    hasDonatedSelect.addEventListener('change', function() {
        bloodBankDetails.style.display = this.value === 'yes' ? 'block' : 'none';
    });

    hasChronicDiseaseSelect.addEventListener('change', function() {
        chronicDiseaseDetails.style.display = this.value === 'yes' ? 'block' : 'none';
    });
});
</script>
{% endblock %} 